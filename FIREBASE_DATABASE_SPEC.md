# MoneyRush Firebase Database Architecture

## Table of Contents
1. [Database Structure Overview](#database-structure-overview)
2. [Collections & Schema](#collections--schema)
3. [Data Relationships](#data-relationships)
4. [Form Data Mappings](#form-data-mappings)
5. [Security Rules](#security-rules)
6. [Data Flow Diagrams](#data-flow-diagrams)
7. [Query Patterns](#query-patterns)
8. [Scalability & Best Practices](#scalability--best-practices)

---

## Database Structure Overview

MoneyRush uses Firestore (Firebase's real-time NoSQL database) with the following architecture:

### Top-Level Collections
- `users` - All user accounts (Students, Parents, Teachers, Schools)
- `schools` - Educational institution data
- `demo_requests` - School demo booking requests
- `feedback` - User reviews and testimonials
- `newsletter_signups` - Newsletter subscribers
- `student_progress` - Student learning progress and achievements
- `student_quizzes` - Personalization quiz responses
- `parent_connections` - Parent-student relationships
- `teacher_classes` - Teacher-class mappings
- `analytics` - Aggregated platform analytics

---

## Collections & Schema

### 1. Users Collection
**Path**: `/users/{userId}`

\`\`\`
{
  // Common fields (all user types)
  userId: string (auto-generated by Firebase Auth)
  email: string (unique)
  userType: 'student' | 'parent' | 'teacher' | 'school' (enum)
  accountStatus: 'active' | 'pending_verification' | 'suspended' (enum)
  createdAt: timestamp
  updatedAt: timestamp
  lastLoginAt: timestamp (nullable)
  emailVerified: boolean
  profilePhotoUrl: string (optional)
  
  // Student-specific fields
  firstName: string (if student/parent/teacher)
  lastName: string (if student/parent/teacher)
  dateOfBirth: date (student only)
  gradeLevel: string (student only, e.g., "10th Grade")
  schoolName: string (student only, optional)
  parentEmail: string (student only, if under 18)
  
  // Parent-specific fields
  numberOfChildren: number (parent only)
  childrenAges: array<string> (parent only)
  phoneNumber: string (optional)
  
  // Teacher-specific fields
  schoolName: string (teacher only)
  schoolDistrict: string (teacher only, optional)
  subjectTeaching: string (teacher only)
  gradeTeaching: array<string> (teacher only)
  yearsExperience: '0-1' | '1-5' | '5-10' | '10+' (teacher only)
  affiliationProofUrl: string (teacher only, document storage path)
  affiliationVerified: boolean (teacher only)
  classesManaged: array<string> (teacher only, references to Classes subcollection)
  
  // School/Institution-specific fields
  institutionName: string (school only)
  institutionType: 'public' | 'private' | 'charter' | 'district' | 'university' | 'nonprofit' (school only)
  numberOfStudents: '< 100' | '100-500' | '500-1000' | '1000-5000' | '5000+' (school only)
  address: string (school only)
  city: string (school only)
  stateProvince: string (school only)
  country: string (school only)
  website: string (school only, optional)
  administratorName: string (school only)
  administratorEmail: string (school only)
  
  // Preferences & settings
  languagePreference: string (default: 'en')
  notifications: {
    emailUpdates: boolean
    pushNotifications: boolean
    weeklyReport: boolean
    achievementAlerts: boolean
  }
  
  // Data for future features
  referralCode: string (unique, generated on signup)
  referredBy: string (nullable, userId of referrer)
  subscriptionTier: 'free' | 'premium' | 'institutional' (future)
}
\`\`\`

**Subcollections**:
- `preferences` - User personalization preferences
- `settings` - Privacy and notification settings
- `activity_log` - User activity history

---

### 2. Student_Progress Subcollection
**Path**: `/users/{studentId}/student_progress/{progressId}`

\`\`\`
{
  progressId: string
  studentId: string (reference to parent user)
  moduleId: string (reference to learning module)
  moduleName: string
  lessonsCompleted: number
  totalLessons: number
  progressPercentage: number (0-100)
  currentLevel: number
  experience: number (XP earned)
  badges: array<{
    badgeId: string
    name: string
    icon: string
    unlockedAt: timestamp
  }>
  quizzes: array<{
    quizId: string
    score: number
    totalPoints: number
    completedAt: timestamp
  }>
  lastAccessedAt: timestamp
  createdAt: timestamp
  updatedAt: timestamp
  status: 'in_progress' | 'completed' | 'paused'
}
\`\`\`

---

### 3. Student_Quizzes Subcollection
**Path**: `/users/{studentId}/student_quizzes/{quizResponseId}`

**Purpose**: Stores personalization quiz responses during registration

\`\`\`
{
  quizResponseId: string
  studentId: string
  quizType: 'onboarding_personalization'
  responses: array<{
    questionId: string
    questionText: string
    selectedAnswer: string | number | array<string>
    category: 'financial_habits' | 'learning_preference' | 'goals' | 'interests'
  }>
  generatedProfile: {
    learningStyle: 'visual' | 'kinesthetic' | 'auditory' (inferred)
    riskTolerance: 'conservative' | 'moderate' | 'aggressive'
    interestAreas: array<string>
    recommendedModules: array<string>
    startingLevel: number
  }
  completedAt: timestamp
  createdAt: timestamp
}
\`\`\`

---

### 4. Parent_Connections Subcollection
**Path**: `/users/{parentId}/parent_connections/{connectionId}`

**Purpose**: Maps parent accounts to student accounts for monitoring

\`\`\`
{
  connectionId: string
  parentId: string
  studentId: string
  studentName: string
  relationship: 'parent' | 'guardian' | 'other'
  connectionStatus: 'pending' | 'accepted' | 'rejected'
  createdAt: timestamp
  acceptedAt: timestamp (nullable)
  accessLevel: 'full' | 'limited' | 'view_only'
  
  // Parent monitoring settings
  canViewProgress: boolean
  canViewQuizzes: boolean
  canSetLimits: boolean
  weeklyReportEnabled: boolean
}
\`\`\`

---

### 5. Teacher_Classes Subcollection
**Path**: `/users/{teacherId}/teacher_classes/{classId}`

**Purpose**: Manages teacher's classes and student roster

\`\`\`
{
  classId: string
  teacherId: string
  className: string
  gradeLevel: string
  subject: string
  enrollmentCode: string (unique, for students to join)
  studentRoster: array<{
    studentId: string
    studentName: string
    joinedAt: timestamp
    status: 'active' | 'inactive'
  }>
  assignedModules: array<string> (module IDs)
  maxStudents: number
  enrolledStudents: number
  createdAt: timestamp
  updatedAt: timestamp
}
\`\`\`

---

### 6. Schools Collection
**Path**: `/schools/{schoolId}`

\`\`\`
{
  schoolId: string
  schoolName: string
  schoolType: 'public' | 'private' | 'charter' | 'district' | 'university'
  address: string
  city: string
  stateProvince: string
  country: string
  zipCode: string
  website: string
  phoneNumber: string
  
  // Administration
  primaryAdminId: string (reference to user)
  administratorEmails: array<string>
  teacherCount: number
  studentCount: number
  
  // Program details
  programStatus: 'inquiry' | 'demo_scheduled' | 'pilot' | 'active' | 'inactive'
  startDate: date (nullable)
  enrollmentYear: string (e.g., "2025-2026")
  
  // Custom settings
  curriculumFocus: array<string>
  targetGrades: array<string>
  specialPrograms: array<string>
  
  createdAt: timestamp
  updatedAt: timestamp
}
\`\`\`

**Subcollections**:
- `teachers` - Teachers at this school (references to user IDs)
- `classes` - Classes organized by this school
- `analytics` - School-level analytics and metrics

---

### 7. Demo_Requests Collection
**Path**: `/demo_requests/{requestId}`

\`\`\`
{
  requestId: string
  fullName: string
  schoolName: string
  institutionRole: 'Principal' | 'Teacher' | 'Coordinator' | 'Program Manager'
  workEmail: string
  phoneNumber: string (optional)
  country: string
  city: string
  message: string (optional)
  preferredDemoType: 'live_call' | 'product_tour' | 'email_info_packet' (enum)
  
  // Processing
  status: 'pending' | 'scheduled' | 'completed' | 'no_show' | 'rejected'
  assignedToStaffId: string (nullable, staff member)
  scheduledDate: timestamp (nullable)
  completedDate: timestamp (nullable)
  
  // Metadata
  sourceUrl: string (landing page URL where they initiated)
  createdAt: timestamp
  updatedAt: timestamp
  notes: string (internal staff notes)
}
\`\`\`

---

### 8. Feedback Collection
**Path**: `/feedback/{feedbackId}`

\`\`\`
{
  feedbackId: string
  userId: string (reference to user submitting feedback)
  userName: string
  userRole: 'student' | 'teacher' | 'parent' | 'school' | 'institution'
  rating: number (1-5 stars)
  comment: string (testimonial text)
  
  // Content
  category: 'general' | 'feature_request' | 'bug_report' | 'testimonial'
  isPublished: boolean (whether to show on website)
  isFeatured: boolean (whether to highlight on landing page)
  
  // Metadata
  createdAt: timestamp
  updatedAt: timestamp
  approvedAt: timestamp (nullable)
  approvedBy: string (admin ID, nullable)
}
\`\`\`

---

### 9. Newsletter_Signups Collection
**Path**: `/newsletter_signups/{signupId}`

\`\`\`
{
  signupId: string
  email: string
  firstName: string (optional)
  lastName: string (optional)
  userType: 'general' | 'educator' | 'parent' | 'student' (optional)
  message: string (optional feedback)
  
  subscriptionStatus: 'subscribed' | 'unsubscribed' | 'bounced'
  verificationToken: string
  emailVerified: boolean
  
  source: string (e.g., 'landing_page', 'signup_form')
  sourceUrl: string (referrer URL)
  
  createdAt: timestamp
  subscribedAt: timestamp (nullable)
  unsubscribedAt: timestamp (nullable)
}
\`\`\`

---

### 10. Analytics Collection
**Path**: `/analytics/{analyticsId}`

**Purpose**: Aggregated metrics for dashboard and reporting (updated daily/weekly)

\`\`\`
{
  analyticsId: string
  date: date (YYYY-MM-DD format for easy querying)
  period: 'daily' | 'weekly' | 'monthly'
  
  // User metrics
  totalUsers: number
  activeUsers: number (logged in last 7 days)
  newSignups: number
  signupsByType: {
    students: number
    parents: number
    teachers: number
    schools: number
  }
  
  // Engagement
  averageSessionDuration: number (in seconds)
  totalSessions: number
  returningUserRate: number (percentage)
  dailyActiveUsers: number
  
  // Feature usage
  modulesCompleted: number
  quizzesAttempted: number
  averageQuizScore: number
  badgesUnlocked: number
  
  // Demo requests
  demoRequestsReceived: number
  demoConversionsScheduled: number
  
  createdAt: timestamp
  updatedAt: timestamp
}
\`\`\`

---

## Data Relationships

### One-to-Many
- **User → Student_Progress**: One student has many progress records (one per module)
- **User (Parent) → Parent_Connections**: One parent can monitor multiple students
- **User (Teacher) → Teacher_Classes**: One teacher teaches multiple classes
- **School → Teachers**: One school has many teachers
- **User (Student) → Student_Quizzes**: One student completes quizzes (multiple responses)

### Many-to-Many
- **Teachers ↔ Students**: Many teachers teach many students (managed via classes)
- **Students ↔ Classes**: Many students enroll in many classes

### Reference Fields (Foreign Keys)
- `student_progress.studentId` → `users.userId`
- `parent_connections.parentId` → `users.userId`
- `parent_connections.studentId` → `users.userId`
- `demo_requests.assignedToStaffId` → `users.userId` (staff members)
- `schools.primaryAdminId` → `users.userId`
- `feedback.userId` → `users.userId`

---

## Form Data Mappings

### 1. Register Form (Step 1: Role Selection)
**Destination**: Temporary state (Redux/Context)
**Data Collected**:
\`\`\`
{
  selectedUserType: 'student' | 'parent' | 'teacher' | 'school'
}
\`\`\`

### 2. Register Form (Step 2: Basic Info)
**Destination**: `/users/{userId}` + Firebase Auth
**Data Collected by User Type**:

**All Users**:
\`\`\`
{
  email: string (→ Firebase Auth + users.email)
  password: string (→ Firebase Auth only)
  firstName: string (→ users.firstName)
  lastName: string (→ users.lastName)
}
\`\`\`

**Student**:
\`\`\`
{
  dateOfBirth: date (→ users.dateOfBirth)
  gradeLevel: string (→ users.gradeLevel)
  schoolName: string (→ users.schoolName)
  parentEmail: string (→ users.parentEmail, required if <18)
}
\`\`\`

**Parent**:
\`\`\`
{
  numberOfChildren: number (→ users.numberOfChildren)
  childrenAges: array<string> (→ users.childrenAges)
  phoneNumber: string (→ users.phoneNumber)
}
\`\`\`

**Teacher**:
\`\`\`
{
  schoolName: string (→ users.schoolName)
  schoolDistrict: string (→ users.schoolDistrict)
  subjectTeaching: string (→ users.subjectTeaching)
  gradeTeaching: array<string> (→ users.gradeTeaching)
  yearsExperience: string (→ users.yearsExperience)
  affiliationProof: File (→ Cloud Storage, URL saved to users.affiliationProofUrl)
}
\`\`\`

**School/Institution**:
\`\`\`
{
  institutionName: string (→ users.institutionName)
  institutionType: string (→ users.institutionType)
  numberOfStudents: string (→ users.numberOfStudents)
  address: string (→ users.address)
  city: string (→ users.city)
  stateProvince: string (→ users.stateProvince)
  country: string (→ users.country)
  website: string (→ users.website, optional)
  administratorName: string (→ users.firstName, lastName)
  additionalInfo: string (local processing or future field)
}
\`\`\`

### 3. Register Form (Step 3: Personalization Quiz - Students Only)
**Destination**: `/users/{studentId}/student_quizzes/{quizResponseId}`
**Data Collected**:
\`\`\`
{
  quizType: 'onboarding_personalization'
  responses: [
    {
      questionId: 'q1',
      questionText: 'What interests you most?',
      selectedAnswer: ['stocks', 'real_estate']
    },
    {
      questionId: 'q2',
      questionText: 'Learning preference?',
      selectedAnswer: 'visual'
    },
    // ... more responses
  ]
}
// After processing, generate:
{
  generatedProfile: {
    learningStyle: 'visual',
    riskTolerance: 'moderate',
    interestAreas: ['stocks', 'real_estate'],
    recommendedModules: ['investing_101', 'real_estate_basics'],
    startingLevel: 2
  }
}
\`\`\`

### 4. Login Form
**Destination**: Firebase Auth (authenticates user)
**Data Collected**:
\`\`\`
{
  email: string (→ Firebase Auth)
  password: string (→ Firebase Auth)
  rememberMe: boolean (→ localStorage)
}
// On successful login, retrieve user profile from `/users/{userId}`
\`\`\`

### 5. Password Reset Form
**Destination**: Firebase Auth
**Data Collected**:
\`\`\`
{
  email: string (→ sendPasswordResetEmail())
}
// User receives email, clicks link, enters:
{
  newPassword: string (→ confirmPasswordReset())
  confirmPassword: string (validation)
}
\`\`\`

### 6. School Demo Form
**Destination**: `/demo_requests/{requestId}`
**Data Collected**:
\`\`\`
{
  fullName: string (→ demo_requests.fullName)
  schoolName: string (→ demo_requests.schoolName)
  institutionRole: string (→ demo_requests.institutionRole)
  workEmail: string (→ demo_requests.workEmail)
  phoneNumber: string (→ demo_requests.phoneNumber, optional)
  country: string (→ demo_requests.country)
  city: string (→ demo_requests.city)
  message: string (→ demo_requests.message, optional)
  preferredDemoType: string (→ demo_requests.preferredDemoType)
}
\`\`\`

### 7. Feedback Form (on Landing Page)
**Destination**: `/feedback/{feedbackId}`
**Data Collected**:
\`\`\`
{
  userName: string (→ feedback.userName)
  userRole: string (→ feedback.userRole)
  rating: number (→ feedback.rating, 1-5)
  comment: string (→ feedback.comment)
}
// Created by: authenticated user (if logged in) or anonymous with email
\`\`\`

### 8. Newsletter Signup
**Destination**: `/newsletter_signups/{signupId}`
**Data Collected**:
\`\`\`
{
  email: string (→ newsletter_signups.email)
  firstName: string (→ newsletter_signups.firstName, optional)
  userType: string (→ newsletter_signups.userType, optional)
  message: string (→ newsletter_signups.message, optional)
}
\`\`\`

---

## Security Rules

### Firestore Security Rules

\`\`\`javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isUserOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isTeacherOfStudent(studentId) {
      let student = get(/databases/$(database)/documents/users/$(studentId)).data;
      return isAuthenticated() && 
             student.teacherIds.includes(request.auth.uid);
    }
    
    function isParentOfStudent(studentId) {
      let connections = get(/databases/$(database)/documents/users/$(request.auth.uid)/parent_connections).data;
      return isAuthenticated() && 
             connections.map(c => c.studentId).includes(studentId);
    }
    
    // ============================================================
    // USERS COLLECTION
    // ============================================================
    
    match /users/{userId} {
      // Read: Users can read their own profile, admins can read all
      allow read: if isUserOwner(userId) || isAdmin();
      
      // Create: Only during signup via Cloud Function
      allow create: if false; // Handled by Cloud Function
      
      // Update: Users can update their own profile (limited fields)
      allow update: if isUserOwner(userId) && 
                      request.resource.data.email == resource.data.email && // Email immutable
                      request.resource.data.userId == resource.data.userId && // ID immutable
                      request.resource.data.userType == resource.data.userType; // Type immutable
      
      // Delete: Users cannot delete their own account (soft delete via flag)
      allow delete: if false;
      
      // ============================================================
      // STUDENT PROGRESS SUBCOLLECTION
      // ============================================================
      
      match /student_progress/{progressId} {
        allow read: if isUserOwner(userId) || 
                       isParentOfStudent(userId) ||
                       isTeacherOfStudent(userId) ||
                       isAdmin();
        
        allow create, update: if isUserOwner(userId);
        allow delete: if false; // Soft delete via status field
      }
      
      // ============================================================
      // STUDENT QUIZZES SUBCOLLECTION
      // ============================================================
      
      match /student_quizzes/{quizId} {
        allow read: if isUserOwner(userId) || isAdmin();
        allow create, update: if isUserOwner(userId);
        allow delete: if false;
      }
      
      // ============================================================
      // PARENT CONNECTIONS SUBCOLLECTION
      // ============================================================
      
      match /parent_connections/{connectionId} {
        allow read: if isUserOwner(userId);
        allow create: if false; // Must be created by invitation process
        allow update: if isUserOwner(userId) && 
                       request.resource.data.parentId == resource.data.parentId &&
                       request.resource.data.studentId == resource.data.studentId;
        allow delete: if isUserOwner(userId);
      }
      
      // ============================================================
      // TEACHER CLASSES SUBCOLLECTION
      // ============================================================
      
      match /teacher_classes/{classId} {
        allow read: if isUserOwner(userId) || isAdmin();
        allow create, update: if isUserOwner(userId) && 
                              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'teacher';
        allow delete: if isUserOwner(userId);
      }
      
      // ============================================================
      // USER PREFERENCES SUBCOLLECTION
      // ============================================================
      
      match /preferences/{prefId} {
        allow read, write: if isUserOwner(userId);
      }
    }
    
    // ============================================================
    // SCHOOLS COLLECTION
    // ============================================================
    
    match /schools/{schoolId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() || 
                             (isAuthenticated() && 
                              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'school');
      allow delete: if isAdmin();
      
      match /teachers/{teacherId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      match /classes/{classId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      match /analytics/{analyticsId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
    }
    
    // ============================================================
    // DEMO REQUESTS COLLECTION
    // ============================================================
    
    match /demo_requests/{requestId} {
      // Anyone can submit a demo request
      allow create: if true;
      
      // Can read own request if they have the email
      allow read: if request.auth == null || 
                     (isAuthenticated() && isAdmin());
      
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }
    
    // ============================================================
    // FEEDBACK COLLECTION
    // ============================================================
    
    match /feedback/{feedbackId} {
      // Anyone can submit feedback
      allow create: if true;
      
      // Anyone can read published feedback
      allow read: if resource.data.isPublished == true || isAdmin();
      
      // Only authors or admins can update
      allow update: if isUserOwner(resource.data.userId) || isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // NEWSLETTER SIGNUPS COLLECTION
    // ============================================================
    
    match /newsletter_signups/{signupId} {
      // Anyone can subscribe
      allow create: if true;
      
      // Users can read their own signup
      allow read: if request.auth == null || isAdmin();
      
      // Users can update their own subscription
      allow update: if resource.data.email == request.resource.data.email;
      
      // Admins only for delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ANALYTICS COLLECTION
    // ============================================================
    
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated() && isAdmin();
      allow write: if false; // Server-side only (Cloud Functions)
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
\`\`\`

---

## Data Flow Diagrams

### Registration Flow

\`\`\`
Frontend (User fills form)
    ↓
Client-side validation
    ↓
Call Cloud Function: createUserAccount()
    ↓
Cloud Function:
  1. Create Firebase Auth user
  2. Create `/users/{userId}` document
  3. If student: create `/users/{userId}/student_quizzes` doc
  4. If teacher: upload file to Cloud Storage
  5. Return userId to frontend
    ↓
Frontend: Store auth token, redirect to dashboard/onboarding
\`\`\`

### Login Flow

\`\`\`
User enters email + password
    ↓
Client: signInWithEmailAndPassword()
    ↓
Firebase Auth validates
    ↓
Frontend: Fetch user profile from `/users/{userId}`
    ↓
Store user data in Context/Redux
    ↓
Redirect to dashboard/home based on userType
\`\`\`

### Student Progress Tracking

\`\`\`
Student completes module/quiz
    ↓
Frontend emits event: updateProgress(moduleId, score)
    ↓
Cloud Function: updateStudentProgress()
    ↓
Function:
  1. Update `/users/{studentId}/student_progress/{moduleId}`
  2. Calculate new XP, level, badges
  3. Update `/users/{studentId}` (currentLevel, totalXP)
  4. Check for unlocked badges → create entries
  5. Log to analytics
    ↓
Frontend: Real-time listener updates UI
\`\`\`

### Parent-Student Connection

\`\`\`
Parent initiates connection
    ↓
Cloud Function: createParentInvitation()
    ↓
Function:
  1. Send invitation email to student
  2. Create pending connection record
    ↓
Student clicks invitation link
    ↓
Update `/users/{parentId}/parent_connections/{connectionId}`
  - Change status from "pending" to "accepted"
    ↓
Both can now sync data (parent can view student progress)
\`\`\`

### School Demo Request

\`\`\`
User fills demo form
    ↓
Frontend: submitDemoRequest()
    ↓
Write to `/demo_requests/{newId}`
    ↓
Cloud Function: onDemoRequestCreated()
    ↓
Function:
  1. Send confirmation email to user
  2. Send notification to admin
  3. Log to analytics
  4. Trigger CRM sync (e.g., Salesforce)
    ↓
Admin dashboard shows new request
\`\`\`

### Feedback Submission

\`\`\`
User submits feedback
    ↓
Frontend: submitFeedback()
    ↓
Write to `/feedback/{newId}`
    ↓
Cloud Function: onFeedbackCreated()
    ↓
Function:
  1. Flag for admin review (isPublished = false)
  2. Send email notification to admins
  3. If auto-approved (high rating): set isPublished = true
  4. Update analytics
    ↓
Admin approves/rejects feedback
    ↓
Frontend: Real-time listener shows new feedback on carousel
\`\`\`

---

## Query Patterns

### Key Frontend Queries

**1. Fetch User Profile**
\`\`\`javascript
// Path: /users/{userId}
// Used on: Login, Dashboard, Settings
// Frequency: On login, then periodic refresh
const userRef = doc(db, 'users', userId);
const userSnap = await getDoc(userRef);
\`\`\`

**2. Fetch Student Progress (with real-time listener)**
\`\`\`javascript
// Path: /users/{studentId}/student_progress
// Used on: Student Dashboard, Parent Monitoring
// Frequency: Real-time on page load
const progressRef = collection(db, 'users', studentId, 'student_progress');
const q = query(progressRef, orderBy('updatedAt', 'desc'));
const unsubscribe = onSnapshot(q, (snapshot) => {
  // Update UI with progress data
});
\`\`\`

**3. Fetch Parent's Connected Students**
\`\`\`javascript
// Path: /users/{parentId}/parent_connections
// Used on: Parent Dashboard
const connectionsRef = collection(db, 'users', parentId, 'parent_connections');
const q = query(connectionsRef, where('connectionStatus', '==', 'accepted'));
const snapshot = await getDocs(q);
\`\`\`

**4. Fetch Published Feedback (Carousel)**
\`\`\`javascript
// Path: /feedback
// Used on: Landing page, testimonials section
// Frequency: Once on page load
const feedbackRef = collection(db, 'feedback');
const q = query(
  feedbackRef,
  where('isPublished', '==', true),
  orderBy('createdAt', 'desc'),
  limit(10)
);
const snapshot = await getDocs(q);
\`\`\`

**5. Fetch Pending Demo Requests (Admin)**
\`\`\`javascript
// Path: /demo_requests
// Used on: Admin dashboard
const demoRef = collection(db, 'demo_requests');
const q = query(
  demoRef,
  where('status', '==', 'pending'),
  orderBy('createdAt', 'desc')
);
const snapshot = await getDocs(q);
\`\`\`

**6. Fetch Teacher's Classes**
\`\`\`javascript
// Path: /users/{teacherId}/teacher_classes
// Used on: Teacher Dashboard
const classesRef = collection(db, 'users', teacherId, 'teacher_classes');
const snapshot = await getDocs(classesRef);
\`\`\`

**7. Aggregate Daily Analytics**
\`\`\`javascript
// Path: /analytics
// Used on: Admin Analytics Dashboard
// Query by date range
const analyticsRef = collection(db, 'analytics');
const q = query(
  analyticsRef,
  where('date', '>=', startDate),
  where('date', '<=', endDate),
  orderBy('date', 'desc')
);
const snapshot = await getDocs(q);
\`\`\`

---

## Scalability & Best Practices

### 1. Collection Structure Optimization

**Problem**: Storing all user data in a single document causes document size limits and read/write contention.

**Solution**: Separate concerns into subcollections
\`\`\`
/users/{userId} → Basic profile
  └─ /student_progress → Progress data (frequent updates)
  └─ /student_quizzes → Quiz responses (immutable)
  └─ /preferences → User settings
  └─ /parent_connections → Relationship data
\`\`\`

### 2. Composite Indexes

**Create indexes for common queries**:
\`\`\`
Collection: demo_requests
Fields: status (Asc), createdAt (Desc)

Collection: feedback
Fields: isPublished (Asc), createdAt (Desc)

Collection: analytics
Fields: date (Desc), period (Asc)
\`\`\`

### 3. Denormalization Strategy

**User names in demo_requests** (instead of just IDs):
\`\`\`javascript
// Good: No additional reads needed
{
  fullName: "John Doe",
  schoolName: "Lincoln High",
  ...
}

// Avoid: Requires additional read
{
  userId: "abc123"
  // Must fetch /users/abc123 to get name
}
\`\`\`

### 4. Real-time Listeners (Careful Usage)

**Best practice**: Use unsubscribe to prevent leaks
\`\`\`javascript
let unsubscribe;

// Component mount
useEffect(() => {
  unsubscribe = onSnapshot(...);
  
  // Cleanup on unmount
  return () => {
    if (unsubscribe) unsubscribe();
  };
}, []);
\`\`\`

### 5. Pagination for Large Datasets

**Demo requests listing** (admin dashboard):
\`\`\`javascript
const pageSize = 20;
const demoRef = collection(db, 'demo_requests');

// First page
let q = query(
  demoRef,
  orderBy('createdAt', 'desc'),
  limit(pageSize)
);
let snapshot = await getDocs(q);
let lastVisible = snapshot.docs[snapshot.docs.length - 1];

// Next page
let nextQ = query(
  demoRef,
  orderBy('createdAt', 'desc'),
  startAfter(lastVisible),
  limit(pageSize)
);
let nextSnapshot = await getDocs(nextQ);
\`\`\`

### 6. Batch Writes

**Update student level + XP + update analytics in one batch**:
\`\`\`javascript
const batch = writeBatch(db);

// Update user progress
batch.update(progressRef, { level: newLevel, xp: newXP });

// Update user profile
batch.update(userRef, { currentLevel: newLevel });

// Log to analytics
batch.set(analyticsRef, { ...analyticsData }, { merge: true });

await batch.commit();
\`\`\`

### 7. Cloud Functions for Complex Operations

**Create student account (multi-step process)**:
\`\`\`javascript
// Handles:
// 1. Firebase Auth creation
// 2. User profile creation
// 3. Profile initialization
// 4. Email verification
// 5. Audit logging
// 6. Webhook to external services

export const createUserAccount = functions.https.onCall(async (data, context) => {
  // Complex logic here
});
\`\`\`

### 8. Data Retention & Archival

**Archive old feedback** (to reduce read costs):
\`\`\`
/feedback/{feedbackId}
  - Keep published testimonials indefinitely
  - Archive unpublished feedback >90 days old
  - Delete spam/inappropriate feedback

/demo_requests/{requestId}
  - Archive completed demos >1 year
  - Keep pending/recent for 6 months
\`\`\`

### 9. Monitoring & Cost Optimization

**Potential issues**:
- High read costs: Too many real-time listeners
- Write costs: Updating progress on every quiz attempt
- Storage costs: Storing large files in Firestore (use Cloud Storage)

**Solutions**:
- Batch updates (e.g., sync progress every 5 minutes)
- Cache frequently accessed data in frontend
- Use Cloud Storage for files (affiliationProofUrl)
- Archive old analytics data

### 10. GDPR & Data Privacy

**Implement data deletion**:
\`\`\`javascript
// Soft delete (recommended)
batch.update(userRef, {
  accountStatus: 'deleted',
  deletedAt: serverTimestamp(),
  email: '[deleted]',
  // Clear PII fields
});

// Hard delete (via scheduled Cloud Function)
// Permanently remove user documents after 30-day grace period
\`\`\`

---

## Summary: Form-to-Database Mapping

| Form | Destination | Key Fields |
|------|-------------|-----------|
| Register (Student) | `/users/{userId}` | firstName, email, dateOfBirth, gradeLevel |
| Register (Parent) | `/users/{userId}` | firstName, email, numberOfChildren |
| Register (Teacher) | `/users/{userId}` | firstName, email, schoolName, affiliationProofUrl |
| Register (School) | `/users/{userId}` | institutionName, country, institutionType |
| Student Personalization Quiz | `/users/{studentId}/student_quizzes` | responses, generatedProfile |
| Login | Firebase Auth | email, password |
| Password Reset | Firebase Auth | email (verification) |
| School Demo | `/demo_requests` | fullName, schoolName, preferredDemoType |
| Feedback | `/feedback` | userName, rating, comment |
| Newsletter | `/newsletter_signups` | email, firstName |

---

This document should be your blueprint for implementing the complete MoneyRush backend with Firebase. All security rules, data relationships, and query patterns are production-ready.
